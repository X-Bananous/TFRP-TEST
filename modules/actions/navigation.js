
import { state } from '../state.js';
import { render, router } from '../utils.js';
import { ui } from '../ui.js';
import { 
    loadCharacters, fetchBankData, fetchInventory, fetchActiveHeistLobby, 
    fetchGangs, fetchActiveGang, fetchBounties, fetchDrugLab, 
    fetchGlobalHeists, fetchEmergencyCalls, fetchAllCharacters, fetchAllReports, fetchEnterprises,
    fetchERLCData, fetchPendingApplications, fetchStaffProfiles, fetchOnDutyStaff, 
    fetchServerStats, fetchPendingHeistReviews, fetchAvailableLobbies,
    fetchActiveSession, fetchSessionHistory, fetchEnterpriseMarket, fetchMyEnterprises, fetchEnterpriseDetails,
    fetchDailyEconomyStats, fetchPlayerInvoices, fetchTopSellers, fetchNotifications, fetchSecureConfig, fetchLawyers
} from '../services.js';
import { hasPermission } from '../utils.js';

export const backToSelect = async () => {
    state.activeCharacter = null;
    state.bankAccount = null;
    
    // Clean Session Storage for character
    sessionStorage.removeItem('tfrp_active_char');
    sessionStorage.removeItem('tfrp_hub_panel');
    
    if(state.heistTimerInterval) clearInterval(state.heistTimerInterval);
    state.activeHeist = null;
    state.activeHeistLobby = null; 
    await loadCharacters();
    router('select');
};

export const toggleSidebarSection = (sectionId) => {
    const idx = state.ui.sidebarCollapsedSections.indexOf(sectionId);
    if (idx === -1) {
        state.ui.sidebarCollapsedSections.push(sectionId);
    } else {
        state.ui.sidebarCollapsedSections.splice(idx, 1);
    }
    render();
};

export const selectCharacter = async (charId) => {
    const char = state.characters.find(c => c.id === charId);
    if (char && char.status === 'accepted') {
        state.activeCharacter = char;
        state.activeHubPanel = 'main';
        state.alignmentModalShown = false; 
        
        // Save to Session
        sessionStorage.setItem('tfrp_active_char', charId);
        
        // Trigger initial data fetch for the Hub before rendering
        state.isPanelLoading = true;
        router('hub'); // Switch view to Hub (will show loader)
        
        try {
             await Promise.all([
                fetchActiveSession(), // Ensure session status is known immediately
                fetchGlobalHeists(),
                fetchERLCData(),
                fetchOnDutyStaff(),
                fetchNotifications(),
                fetchSecureConfig() // Load economy keys on select
            ]);
        } catch(e) {
            console.warn("Initial hub fetch failed", e);
        } finally {
            state.isPanelLoading = false;
            render();
        }
    }
};

export const goToCreate = () => {
    router('create');
};

export const cancelCreate = () => router('select');

export const goBackFromLegal = () => {
    // Contextual Back Navigation
    if (state.user) {
        if (state.activeCharacter) {
            router('hub');
        } else {
            router('select');
        }
    } else {
        router('login');
    }
};

export const setHubPanel = async (panel) => {
    state.activeHubPanel = panel;
    
    // Save Panel State
    sessionStorage.setItem('tfrp_hub_panel', panel);
    
    state.isPanelLoading = true; // Show loader
    render(); 
    
    try {
        // --- LAZY DATA LOADING ---
        if (panel === 'main') {
            await Promise.all([
                fetchActiveSession(),
                fetchGlobalHeists(),
                fetchERLCData(),
                fetchOnDutyStaff(),
                fetchNotifications(),
                fetchSecureConfig()
            ]);
        } else if (panel === 'profile') {
            // Nothing special to load for profile yet
        } else if (panel === 'notifications') {
            await fetchNotifications();
        } else if (panel === 'bank' && state.activeCharacter) {
            state.selectedRecipient = null;
            state.filteredRecipients = [];
            await fetchBankData(state.activeCharacter.id);
        } else if (panel === 'assets' && state.activeCharacter) {
            state.inventoryFilter = '';
            await Promise.all([
                fetchInventory(state.activeCharacter.id),
                fetchPlayerInvoices(state.activeCharacter.id)
            ]);
        } else if (panel === 'enterprise') {
            const promises = [fetchDailyEconomyStats(), fetchSecureConfig()];
            if (state.activeCharacter) {
                promises.push(fetchBankData(state.activeCharacter.id));
            }
            if(state.activeEnterpriseTab === 'market') {
                promises.push(fetchEnterpriseMarket());
                promises.push(fetchTopSellers()); 
            }
            else if(state.activeEnterpriseTab === 'my_companies' && state.activeCharacter) {
                promises.push(fetchMyEnterprises(state.activeCharacter.id));
            }
            await Promise.all(promises);

        } else if (panel === 'illicit' && state.activeCharacter) {
            state.activeIllicitTab = 'dashboard'; 
            state.blackMarketSearch = ''; 
            // Fetch gang first, then lab
            await fetchActiveGang(state.activeCharacter.id);
            const illicitPromises = [
                fetchBankData(state.activeCharacter.id),
                fetchGangs(),
                fetchBounties(),
                fetchActiveHeistLobby(state.activeCharacter.id),
                fetchAllCharacters(),
                fetchSecureConfig(),
                fetchAllReports() // Required for Risk Index
            ];
            if (state.activeGang) {
                illicitPromises.push(fetchDrugLab(state.activeGang.id));
            }
            await Promise.all(illicitPromises);

        } else if (panel === 'services' && state.activeCharacter) {
            const job = state.activeCharacter.job;
            if (job === 'maire' || job === 'adjoint') {
                state.activeServicesTab = 'gov';
            } else if (job === 'leo') {
                state.activeServicesTab = 'dispatch';
            } else {
                state.activeServicesTab = 'directory';
            }
            
            state.servicesSearchQuery = '';
            state.reportSuspects = [];
            
            const promises = [
                fetchGlobalHeists(), 
                fetchEmergencyCalls(), 
                fetchSecureConfig(),
                fetchAllCharacters(),
                fetchAllReports(),
                fetchEnterprises(),
                fetchServerStats(),
                fetchDailyEconomyStats() // AJOUTÉ : Pour que le Maire ait ses stats au premier chargement
            ];
            
            if(job === 'leo' || job === 'lawyer' || job === 'lafd' || job === 'ladot') {
                promises.push(fetchERLCData());
            }
            
            await Promise.all(promises);
            
        } else if (panel === 'staff_list') {
            await fetchActiveSession();
            await fetchStaffProfiles();
            await fetchOnDutyStaff();
        } else if (panel === 'lawyers_list') {
            await fetchActiveSession();
            await fetchLawyers();
        } else if (panel === 'advent' && state.activeCharacter) {
            await fetchInventory(state.activeCharacter.id);
        } else if (panel === 'staff') {
            state.staffSearchQuery = ''; 
            if (hasPermission('can_approve_characters')) state.activeStaffTab = 'applications';
            else if (hasPermission('can_manage_economy') || hasPermission('can_manage_illegal')) state.activeStaffTab = 'economy';
            else if (hasPermission('can_manage_staff')) state.activeStaffTab = 'permissions';
            else state.activeStaffTab = 'database'; 
            
            const promises = [
                fetchActiveSession(),
                fetchPendingApplications(), 
                fetchAllCharacters(),
                fetchStaffProfiles(),
                fetchOnDutyStaff(),
                fetchSecureConfig()
            ];
            if(hasPermission('can_manage_economy') || hasPermission('can_manage_illegal')) promises.push(fetchServerStats());
            if(hasPermission('can_manage_illegal')) {
                promises.push(fetchPendingHeistReviews());
                promises.push(fetchGangs());
            }
            await Promise.all(promises);
            await fetchERLCData(); 
        }
    } catch (e) {
        console.error("Panel load error:", e);
        ui.showToast("Erreur de chargement des données.", 'error');
    } finally {
        state.isPanelLoading = false;
        render();
    }
};

export const clearNotifications = async () => {
    if (!state.user || !state.supabase) return;
    
    ui.showModal({
        title: "Nettoyage du Centre",
        content: "Voulez-vous effacer toutes vos notifications personnelles ? Les annonces globales ne seront pas affectées.",
        confirmText: "Tout effacer",
        type: "danger",
        onConfirm: async () => {
            const { error } = await state.supabase
                .from('notifications')
                .delete()
                .eq('user_id', state.user.id);
            
            if (!error) {
                ui.showToast("Flux personnel réinitialisé.", "success");
                await fetchNotifications();
                render();
            } else {
                ui.showToast("Erreur lors de la suppression.", "error");
            }
        }
    });
};

export const deleteNotification = async (id) => {
    if (!state.user || !state.supabase) return;
    
    const { error } = await state.supabase
        .from('notifications')
        .delete()
        .eq('id', id)
        .eq('user_id', state.user.id);
    
    if (!error) {
        await fetchNotifications();
        render();
    } else {
        ui.showToast("Impossible de supprimer cette entrée.", "error");
    }
};

export const refreshCurrentView = async () => {
    const btn = document.getElementById('refresh-data-btn');
    if(btn) {
        const icon = btn.querySelector('i');
        if(icon) icon.classList.add('animate-spin');
        btn.disabled = true;
    }

    const charId = state.activeCharacter?.id;

    try {
        await fetchSecureConfig();

        if (state.activeHubPanel === 'notifications') {
            await fetchNotifications();
        }
        else if (state.activeHubPanel === 'assets') {
            await fetchInventory(charId);
            await fetchPlayerInvoices(charId);
        }
        else if (state.activeHubPanel === 'illicit') {
            await fetchActiveGang(charId);
            if (state.activeIllicitTab === 'heists') await fetchAvailableLobbies(charId);
            if (state.activeIllicitTab === 'gangs') await fetchGangs();
            if (state.activeIllicitTab === 'bounties') await fetchBounties();
            if (state.activeIllicitTab === 'market') await fetchBankData(charId);
            if (state.activeIllicitTab === 'drugs' && state.activeGang) await fetchDrugLab(state.activeGang.id);
            await fetchAllReports();
        }
        else if (state.activeHubPanel === 'services') {
            await fetchAllCharacters();
            await fetchEnterprises();
            await fetchAllReports();
            await fetchServerStats(); // Refresh stats also
            await fetchDailyEconomyStats();
            if (state.activeServicesTab === 'map') await fetchERLCData();
            if (state.activeServicesTab === 'dispatch') { await fetchEmergencyCalls(); await fetchGlobalHeists(); }
        }
        else if (state.activeHubPanel === 'staff_list') {
            await fetchStaffProfiles();
            await fetchOnDutyStaff();
        }
        else if (state.activeHubPanel === 'lawyers_list') {
            await fetchLawyers();
        }
        else if (state.activeHubPanel === 'enterprise') {
             await fetchDailyEconomyStats();
             if(charId) await fetchBankData(charId); 
             if (state.activeEnterpriseTab === 'market') {
                 await fetchEnterpriseMarket();
                 await fetchTopSellers(); 
             }
             if (state.activeEnterpriseTab === 'my_companies' && charId) await fetchMyEnterprises(charId);
             if (state.activeEnterpriseTab === 'manage' && state.activeEnterpriseManagement) await fetchEnterpriseDetails(state.activeEnterpriseManagement.id);
        }
        else if (state.activeHubPanel === 'staff') {
            if (state.activeStaffTab === 'applications') await fetchPendingApplications();
            if (state.activeStaffTab === 'database') await fetchAllCharacters();
            if (state.activeStaffTab === 'economy') { await fetchAllCharacters(); await fetchServerStats(); }
            if (state.activeStaffTab === 'illegal') { await fetchGangs(); await fetchPendingHeistReviews(); await fetchServerStats(); }
            if (state.activeStaffTab === 'sessions' || state.activeStaffTab === 'logs') { await fetchActiveSession(); await fetchERLCData(); await fetchSessionHistory(); }
        }
        ui.showToast("Données actualisées.", 'success');
    } catch(e) {
        ui.showToast("Erreur lors de l'actualisation.", 'error');
    }

    render();
};

export const toggleSidebar = () => {
    state.ui.sidebarOpen = !state.ui.sidebarOpen;
    render();
};
